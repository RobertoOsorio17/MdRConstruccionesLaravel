#!/bin/bash

# Pre-commit hook to prevent committing sensitive files
# This hook prevents accidental commits of .env files and other sensitive data

echo "üîí Running security pre-commit checks..."

# Check for .env file
if git diff --cached --name-only | grep -q "^\.env$"; then
    echo "‚ùå ERROR: Attempting to commit .env file!"
    echo "   This file contains secrets and should NEVER be committed."
    echo "   Please remove it from the staging area:"
    echo "   git reset HEAD .env"
    exit 1
fi

# Check for .env.local, .env.production, etc.
if git diff --cached --name-only | grep -q "^\.env\."; then
    echo "‚ùå ERROR: Attempting to commit environment file!"
    echo "   Environment files contain secrets and should NEVER be committed."
    echo "   Please remove them from the staging area:"
    echo "   git reset HEAD .env.*"
    exit 1
fi

# Check for common secret patterns in staged files
STAGED_FILES=$(git diff --cached --name-only)

for FILE in $STAGED_FILES; do
    # Skip binary files and deleted files
    if [ ! -f "$FILE" ]; then
        continue
    fi
    
    # Check for potential secrets in the file content
    if git diff --cached "$FILE" | grep -qiE "(password|secret|api_key|private_key|token).*=.*['\"][^'\"]{20,}"; then
        echo "‚ö†Ô∏è  WARNING: Potential secret detected in $FILE"
        echo "   Please review the file to ensure no sensitive data is being committed."
        echo "   If this is a false positive, you can skip this check with:"
        echo "   git commit --no-verify"
        
        # Ask for confirmation
        read -p "   Do you want to continue with the commit? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "‚ùå Commit aborted."
            exit 1
        fi
    fi
done

# Check for large files (> 10MB)
for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
        SIZE=$(stat -f%z "$FILE" 2>/dev/null || stat -c%s "$FILE" 2>/dev/null)
        if [ "$SIZE" -gt 10485760 ]; then
            echo "‚ö†Ô∏è  WARNING: Large file detected: $FILE ($(numfmt --to=iec-i --suffix=B $SIZE 2>/dev/null || echo "$SIZE bytes"))"
            echo "   Consider using Git LFS for large files."
            
            read -p "   Do you want to continue with the commit? (y/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "‚ùå Commit aborted."
                exit 1
            fi
        fi
    fi
done

echo "‚úÖ Security checks passed!"
exit 0

